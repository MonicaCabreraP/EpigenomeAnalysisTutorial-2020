==================================================================
Practical I - Footprint calling & Transcription factor prediction
==================================================================
In the first practical, we will perform a footprint analysis with `HINT <http://www.regulatory-genomics.org/hint/>`_ to identify cell specific binding sites from open chromatin data (ATAC-seq).

**The final version of the practical will be available at 01.09.2020 at the latest.**

Step0: ATAC-seq data preprocessing
-----------------------------------------------
Here, we will analyze ATAC-seq of human mesoderm development obtained from `Koh PW et al 2016 <https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE85066>`_. We have performed all low level analyses using `nfcore/atacseq <https://github.com/nf-core/atacseq>`_, a bioinformatics analysis pipeline used for ATAC-seq data. The results can be found under */data/session1/nf_core_atacseq* and the script is available `here <https://github.com/SchulzLab/EpigenomeAnalysisTutorial-2020/blob/master/session1/run.sh>`_.


Step1: Footprint calling
-----------------------------------------------

Next, we will use `HINT <http://www.regulatory-genomics.org/hint/>`_ to find genomic regions (footprints) with cell specific TF binding sites. For this, HINT requires (1) a sorted bam file containing the aligned reads from the sequencing library (DNase-,ATAC- or histone ChIP-seq) (2) and a bed file including peaks detected in the same sequencing library provided in (1). These peak regions are used by HINT to reduce the search space and can be generated by any  peak caller. We here will only use chromosome 1 so that the whole analysis can be done in 30 minutes.

**1.** First, go to EpigenomeAnalysisTutorial-2020 and create a folder for results:
::
    cd EpigenomeAnalysisTutorial-2020
    mkdir -p ./session1/results/hint_chr1

**2.** Select peaks from chromosome 1
::
    mkdir -p ./session1/results/hint_chr1/peaks
    awk '$1 ~ /^chr(1)$/' ./results/bwa/mergedReplicate/macs/narrowPeak/hESC.mRp.clN_peaks.narrowPeak > ./session1/results/hint_chr1/peaks/hESC.bed
    awk '$1 ~ /^chr(1)$/' ./results/bwa/mergedReplicate/macs/narrowPeak/Cardiac.mRp.clN_peaks.narrowPeak > ./session1/results/hint_chr1/peaks/Cardiac.bed

**3.** Execute the following commands to call footprints for hESC and Cardiac cells:
::

    mkdir -p ./session1/results/hint_chr1/footprints
    rgt-hint footprinting --atac-seq --paired-end --organism=hg38 --output-location=./session1/results/hint_chr1/footprints --output-prefix=hESC ./results/bwa/mergedReplicate/hESC.mRp.clN.sorted.bam ${output_dir}/peaks/hESC.bed
    rgt-hint footprinting --atac-seq --paired-end --organism=hg38 --output-location=./session1/results/hint_chr1/footprints --output-prefix=Cardiac ./results/bwa/mergedReplicate/Cardiac.mRp.clN.sorted.bam ${output_dir}/peaks/Cardiac.bed

This will generate an output file, i.e  ``./session1/results/hint_chr1/footprints/hESC.bed``, containing the genomic locations of the footprints.  HINT also produces a file with ending ".info", which has general statistics from the analysis as no. of footprints, total number of reads and so on.

**4.** We can use `IGV <http://software.broadinstitute.org/software/igv/>`_ to vizualise ATAC-seq signals and footprint predictions in particular loci. First, we can use a special HINT command to generate genomic profiles (bigWig files).
::
    mkdir -p ./session1/results/hint_chr1/tracks
    rgt-hint tracks --bc --bigWig --organism=hg38 --output-location=${output_dir}/tracks --output-prefix=hESC ./results/bwa/mergedReplicate/hESC.mRp.clN.sorted.bam ${output_dir}/peaks/hESC.bed
    rgt-hint tracks --bc --bigWig --organism=hg38 --output-location=${output_dir}/tracks --output-prefix=Cardiac ./results/bwa/mergedReplicate/Cardiac.mRp.clN.sorted.bam ${output_dir}/peaks/Cardiac.bed

This bigwig file contains number of ATAC-seq (or DNAse-seq) reads at each genomic position as estimated by HINT after signal normalization and cleveage bias correction. This is therefore more accurate than simply looking a coverage profiles of a bam file. 

@ivan, we need to re-write this part for footprints visualization in IGV

Open all bigwig and footprint files (bed) generated above in IGV. Remember to set the genome version to hg38 beforehand. You can also enrich the data by opening bam files of histone modifications as H3K4me3, H3K4me1 and H3K27ac (provided in session 1). Check for example the genomic profiles around the gene Zp70, which is part of T cell receptor. We observe that this gene has several open chromatin regions and high levels of histone levels in the start of the gene, which are specific to CD4 T cells. There is also some open chromatin level around exon 3, which is supported by H3K4me1 modifications. This potential enhancer region is also present in distinct degrees in B and LSK cells.

Step2: TF binding site prediction
-----------------------------------

An important question when doing footprint analysis is to evaluate which TF motifs overlap with footprints and evaluate the ATAC-seq profiles around these motifs. RGT suite also offers a tool for finding motif predicted binding sites (MPBSs).

Execute the following commands to do motif matching inside footprints for chromosome 1:
::
    mkdir -p ./session1/results/hint_chr1/motifmatching
    rgt-motifanalysis matching --organism=hg38 --output-location=./session1/results/hint_chr1/motifmatching --input-files ${output_dir}/footprints/hESC.bed ${output_dir}/footprints/Cardiac.bed

The above commands will generate bed files (i.e. Cardiac_mpbs.bed) containing MPBSs overlapping with distinct footprint regions. The 4th column contains the motif name and the 5th column the bit-score of the motif matching.

Step3: Differential footprinting analysis
-----------------------------------

Finally, we use HINT to generate average ATAC-seq profiles around MPBSs. This analysis allows us to inspect the chromatin accessibility and the underlying sequence. Moreover, by comparing the profiles from two ATAC-seq libraries (i.s. hESC vs Cardiac cells), we can get insights on changes in binding in two cells. For this, execute the following commands:
::

    mkdir -p ./session1/results/hint_chr1/diff_footprints
    rgt-hint differential --organism=hg38 --bc --nc 30 --mpbs-files=./session1/results/hint_chr1/motifmatching/hESC_mpbs.bed,./session1/results/hint_chr1/motifmatching/Cardiac_mpbs.bed --reads-files=./results/bwa/mergedReplicate/hESC.mRp.clN.sorted.bam,./results/bwa/mergedReplicate/Cardiac.mRp.clN.sorted.bam --conditions=hESC,Cardiac --output-location=./session1/results/hint_chr1/diff_footprints

@ivan, select one or two factors for visualization
The above commands will generate files with a ATAC-seq profile for each of the motifs founds in the provided mpbs bed files. Let's check the profiles in the comparison LSK and CD4, you will see that ELK4 has higher number of ATAC-seq counts in CD4 cells, while SPI1 has more ATAC-seq in LSK cells. Higher ATAC counts indicates higher activity of the factor in that particular cell. This fits with the results discussed in Lara-Astiaso that SPI1 are more relevant/active in LSK, while ELK4 in CD4 cells.
